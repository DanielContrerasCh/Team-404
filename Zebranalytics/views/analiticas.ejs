<!DOCTYPE html>
<html>
<head>
    <%- include('includes/head.ejs', {permisos: permisos}) %>
</head>
<body>
    <%- include('includes/header.ejs') %>

    <div class="col-md-9 m-auto">
        <div class="container mt-5">
            <h2 class="mb-4">Analiticas</h2>
            <div class="container mt-5">
                <div class="row">
        <% /*
        <div class="col-md-4">
          <div class="form-group mb-3">
            <select class="form-select" name="brand" id="brand" aria-label="Select brand">
              <option selected>Selecciona una marca</option>
              <option value="LUUNA">LUUNA</option>
              <option value="NOOZ">NOOZ</option>
              <option value="MAPPA">MAPPA</option>
            </select>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <input type="number" class="form-control" placeholder="Año" min="YYYY" max="YYYY" step="1">
          </div>
        </div>
        <div class="col-auto d-flex align-items-center">
          <span>a</span>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <input type="number" class="form-control" placeholder="Año" min="YYYY" max="YYYY" step="1">
          </div>
        </div>
        */%>
      </div>
    </div>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Calificación</th>
            <th>Producto</th>
            <th>Promedio de Ventas del Ultimo Año</th>
            <th>Cantidad de Reseñas del Ultimo Año</th>
        </tr>
    </thead>
    <tbody>
        <% for (let i = 0; i < analitics.length; i++) { %>
        <% let analitic = analitics[i]; %>
        <tr data-bs-toggle="collapse" data-bs-target="#row<%= i %>" aria-expanded="false" aria-controls="row<%= i %>">
            <td><%= analitic.ItemCode %></td>
            <td><%= parseInt(analitic.PromedioCalificaciones) %></td>
            <td><%= analitic.NumVentas %></td>
        </tr>
        <tr id="row<%= i %>" class="collapse">
            <td colspan="4">
                <div class="container">
                    <canvas class="myChart" id="myChart<%= i %>"></canvas>
                </div>
            </td>
        </tr>
        <% } %>
    </tbody>
</table>
</div>

<%- include('includes/sidebar.ejs') %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Generar los arrays promedios y meses en el servidor usando EJS
  let promedios = [<%- analitics.map(a => a.PromedioCalificaciones).join(',') %>];
  let meses = [<%- analitics.map(a => `'${a.NombreMes}'`).join(',') %>];

  document.addEventListener('DOMContentLoaded', function() {
      const charts = [];
      document.querySelectorAll('.myChart').forEach((canvas, index) => {
          const ctx = canvas.getContext('2d');
          const data = {
              labels: [meses[index]],
              datasets: [{
                  label: 'Promedios del Ultimo Mes',
                  backgroundColor: 'rgba(255, 99, 132, 0.2)',
                  borderColor: 'rgba(255, 99, 132, 1)',
                  borderWidth: 1,
                  data: [promedios[index]],
              }]
          };
          charts.push(new Chart(ctx, {
              type: 'line',
              data: data,
              options: {
                  scales: {
                      y: {
                          beginAtZero: true
                      }
                  }
              }
          }));
      });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
