<!DOCTYPE html>
<html>
<head>
<%- include('includes/head.ejs', {permisos: permisos}) %>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style src="../public/css/analiticas.css"></style>


</head>
<body>
    <%- include('includes/header.ejs') %>

    <div class="col-md-9 m-auto">
        <div class="container mt-5">
            <h2 class="mb-4">Analíticas</h2>
    
            <div class="container mt-5 d-flex">
                <div class="row flex-fill">
                    <!-- Formulario combinado -->
                    <div class="col-md-6 mb-3">
                        <form id="combinedForm" method="POST" action="/analiticas/filteredAnalytics" class="border p-4 rounded">
                            <h3>Buscar las Analíticas</h3>
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <div class="form-group">
                                <label for="brandInput">Marca:</label>
                                <select class="form-control" id="brandInput" name="brand" aria-placeholder="">
                                    <option selected value=""> Elige una marca</option>
                                    <% brands.forEach(brand => { %>
                                        <option value="<%= brand.NombreMarca %>"><%= brand.NombreMarca %></option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="mt-3" for="itemCode">Código:</label>
                                <input type="text" class="form-control" id="itemCode" name="itemCode" placeholder="LB0000" disabled>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" value="" id="itemCodeCheck">
                                    <label class="form-check-label" for="itemCodeCheck">
                                        Activar búsqueda por código
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="mt-3" for="yearInput">Año:</label>
                                <input type="number" class="form-control" id="yearInput" name="year" placeholder="20##" min="2023" max="2099" step="1">
                            </div>
                            <div class="form-group mt-3">
                                <input type="checkbox" class="form-check-input" id="mostrarCuartiles" name="mostrarCuartiles">
                                <label for="mostrarCuartiles">Mostrar Graficos por Cuartiles</label>
                            </div>
                            <button type="submit" class="btn btn-secondary mt-3">Buscar</button>
                        </form>
                    </div>
    
                    <!-- Gráfica de pastel -->
                    <div class="col">
                        <div class="card" id="card1">
                            <div class="card-body">
                                <h5 class="card-title">Total de reseñas por marca</h5>
                                <div class="chart-container" style="width: 75%; margin: 0 auto;">
                                    <canvas id="pieChartResena"></canvas>
                                </div>
                                <button id="toggleButton1" class="btn btn-primary position-absolute top-0 end-0 m-2">Switch to Card 2</button>
                            </div>
                        </div>
                        <div class="card" id="card2" style="display: none;">
                            <div class="card-body">
                                <h5 class="card-title">Contestación de encuestas</h5>
                                <div class="chart-container" style="width: 75%; margin: 0 auto;">
                                    <canvas id="pieChartEncuesta"></canvas>
                                </div>
                                <button id="toggleButton2" class="btn btn-primary position-absolute top-0 end-0 m-2">Switch to Card 1</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script>
                
    document.addEventListener('DOMContentLoaded', (event) => {
      // Recuperar el estado de la casilla de verificación del almacenamiento local
      let isChecked = localStorage.getItem('itemCodeCheck');
      if (isChecked === 'true') {
        document.getElementById('itemCodeCheck').checked = true;
        document.getElementById('itemCode').disabled = false;
        document.getElementById('brandInput').disabled = true;
      }
    });
    
        document.getElementById('itemCodeCheck').addEventListener('change', function() {
        document.getElementById('itemCode').disabled = !this.checked;
        document.getElementById('brandInput').disabled = this.checked;
    
      // Almacenar el estado de la casilla de verificación en el almacenamiento local
    localStorage.setItem('itemCodeCheck', this.checked);
    });
    
    function submitForm(brand) {
        document.getElementById('brandInput').value = brand;
        document.getElementById('yearInput').value = document.getElementById('year').value; // Establecer el año
        document.getElementById('brandForm').submit();
    } 

    //Inicializar la gráfica 
    const datosJsonResena = <%- JSON.stringify(reviews) %> ;


    let labelsResena = []; // Reemplaza esto con los nombres de las marcas
    for(marca of datosJsonResena){
        labelsResena.push(marca.NombreMarca);
    }
    let dataResena = []; // Reemplaza esto con el número de reseñas para cada marca
    for(marca of datosJsonResena){
        dataResena.push(marca.TotalResenas);
    }

    console.log(dataResena)

    let ctx = document.getElementById('pieChartResena').getContext('2d');

    let chartResenas = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labelsResena,
            datasets: [{
                data: dataResena,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });


    const datosJsonAnswers = <%- JSON.stringify(answers) %> ;


    let labelsAnswers = []; // Reemplaza esto con los nombres de las marcas
    for(marca of datosJsonAnswers){
        labelsAnswers.push(marca.NombreMarca);
    }
    let dataAnswers = []; // Reemplaza esto con el número de reseñas para cada marca
    for(marca of datosJsonAnswers){
        dataAnswers.push(marca.TotalResenasContestadas);
    }

    let ctxEncuestas = document.getElementById('pieChartEncuesta').getContext('2d');

    let chartEncuestas = new Chart(ctxEncuestas, {
        type: 'pie',
        data: {
            labels: labelsAnswers,
            datasets: [{
                data: dataAnswers,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });

document.getElementById('toggleButton1').addEventListener('click', function() {
        let card1 = document.getElementById('card1');
        let card2 = document.getElementById('card2');

        if (card1.style.display === 'none') {
            card1.style.display = 'block';
            card2.style.display = 'none';
        } else {
            card1.style.display = 'none';
            card2.style.display = 'block';
        }
    });

    document.getElementById('toggleButton2').addEventListener('click', function() {
        let card1 = document.getElementById('card1');
        let card2 = document.getElementById('card2');

        if (card1.style.display === 'none') {
            card1.style.display = 'block';
            card2.style.display = 'none';
        } else {
            card1.style.display = 'none';
            card2.style.display = 'block';
        }
    });
</script>

<%- include('includes/sidebar.ejs') %>
</body>
</html>