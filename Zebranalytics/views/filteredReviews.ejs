<!DOCTYPE html>
<html lang="en">

<%- include('includes/head.ejs', {permisos: permisos}) %>
<%- include('includes/header.ejs') %>

<body>

  <div class="col-md-9 m-auto mt-5">
    <div class="container">
      <h2 class="mb-4">Reseñas</h2>
      <div class="container mt-2">
        <form action="/reviews/filteredReviews" method="POST" id="filterForm">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          
          <div class="row mb-3">

            <div class="col-md-3">

              <div class="form-group">
                <label for="brand" class="form-label">Marca</label>
                <select class="form-select" name="brand" id="brand" aria-label="Select brand">
                  <option value=""> Todas las Marcas </option>
                  <% brands.forEach(brand => { %>
                  <option value="<%= brand.NombreMarca %>"><%= brand.NombreMarca %></option>
                  <% }); %>
                </select>
              </div>
              <!-- Col1 -->
            </div>

            <div class="col-md-3">
              <div class="form-group">
                <label for="quarter" class="form-label">Cuartil</label>
                <select class="form-select" name="quarter" id="quarter" aria-label="Selecciona un Cuartil">
                  <option value="">Todo el año</option>
                  <option value='1'>Q1 Enero-Marzo</option>
                  <option value='2'>Q2 Abril-Junio</option>
                  <option value='3'>Q3 Julio-Septiembre</option>
                  <option value='4'>Q4 Octubre-Diciembre</option>
                </select>
              </div>
              <!-- col2 -->
            </div>


            <div class="col-md-3">
              <div class="row">
              <div class="form-group mr-2">
                <label>Año: </label>
                <input class="form-check-input" type="checkbox" id="disableYear" onchange="toggleYearInput()">
                <label for="year" class="form-label"> Todos los años
                    <!-- <label class="form-check-label" for="disableYear">Todos los años</label> -->
                </label>
                </div>

                <input class="form-control" type="number" name="year" id="year" min="2023" step="1" value="2024">
              </div>
              <!-- col3 -->
            </div>


            <div class="col-md-3 d-flex align-items-end">
              <div class="form-group">
                <button class="btn btn-secondary d-inline-block" style="padding: auto 15px;" type="submit">Buscar</button>
              </div>
            </div>
            <!-- row -->
          </div> 

        </form>     
        <form action="/reviews/" method="GET" id="filterForm">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        </form>
      </div>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>Id</th>
          <th>Calificación</th>
          <th>Producto</th>
          <th>Fecha de Contestación</th>
          <th>Visibilidad</th>
          <th></th>
        </tr>
      </thead>
      <tbody>

        <% if (reviews.length === 0) { %>
          <tr class="table-danger">
            <td colspan="6">No hay reseñas guardadas con esas especificaciones.</td>
          </tr>
        <% } else { %>
          <% for (let review of reviews) { %>
            <% 
              let imagenEstrellas = '';
              switch (review.calificacion) {
                  case 1:
                      imagenEstrellas = 'review1.png';
                      break;
                  case 2:
                      imagenEstrellas = 'review2.png';
                      break;
                  case 3:
                      imagenEstrellas = 'review3.png';
                      break;
                  case 4:
                      imagenEstrellas = 'review4.png';
                      break;
                  case 5:
                      imagenEstrellas = 'review5.png';
                      break;
                  default:
                      break;
              }
            %>
            <tr>
              <td><%= review.IDResena %></td>
              <td><img src="/img/stars/<%= imagenEstrellas %>" alt=""></td>
              <td><%= review.ItemCode %></td>
              <td><%= review.FechaContestacion ? review.FechaContestacion.toISOString().substring(0, 10) : "" %></td>
              <td>
                <button type="button" id="changeVisibilityBtn_<%= review.IDResena %>" class="btn color-toggle <%= review.Visibilidad == 1 ? 'btn-success' : 'btn-danger' %>" data-review-id="<%= review.IDResena %>" data-visible="<%= review.visible %>" aria-expanded="false" aria-controls="row_<%= review.IDResena %>" onclick="
                  let button = this;
                  let reviewId = button.getAttribute('data-review-id');
                  let isVisible = button.getAttribute('data-visible') === 'true';

                  fetch(`/reviews/${reviewId}/change-visibility`, {
                    method: 'PUT',
                    headers: {
                      'Content-Type': 'application/json',
                      'csrf-token': '<%= csrfToken %>'
                    }
                  })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json();
                  })
                  .then(data => {
                    isVisible = !isVisible; // Toggle visibility
                    button.classList.toggle('btn-success', isVisible);
                    button.classList.toggle('btn-danger', !isVisible);
                    button.setAttribute('data-visible', isVisible); 
                    alert('Visibilidad cambiada')
                  location.reload();
                  })
                  .catch(error => {
                    console.error('Error:', error);
                  });
                ">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
              <td>
                <button type="button" class="btn btn-light" data-bs-toggle="collapse" data-bs-target="#row_<%= review.IDResena %>" aria-expanded="false" aria-controls="row_<%= review.IDResena %>">
                  <i class="fa-solid fa-caret-down"></i>
                </button>
              </td>
            </tr>
            <tr id="row_<%= review.IDResena %>" class="collapse">
              <td colspan="7">
                <!-- Text -->
                <div>
                  <b>Enviado por</b>
                  <p><%= review.correoComprador %></p>
                  <% preguntasRespuestas.forEach(preguntaRespuesta => { %>
                    <% if(preguntaRespuesta.IDResena === review.IDResena) { %>
                      <ul>
                        <% 
                        let preguntas = preguntaRespuesta.Preguntas.split('|');
                        let respuestas = preguntaRespuesta.Respuestas.split('|');
                        for(let i = 0; i < preguntas.length; i++) { 
                        %>
                          <li>
                            <strong>Pregunta:</strong> <%= preguntas[i] %><br>
                            <strong>Respuesta:</strong> <%= respuestas[i] %>
                          </li>
                        <% } %>
                      </ul>
                    <% } %>
                  <% }); %>
                </div>                           
              </td>
            </tr>
          <% } %>
        <% } %>
      <table class="table">
        <!-- ... existing table code ... -->
      </table>
      
      <div class="fixed-bottom bg-light border-top py-3">
        <div class="container">
          <div class="d-flex justify-content-between">
            <a href="/reviews/" class="btn btn-outline-dark">Regresar <i class="bi bi-arrow-90deg-left"></i></a>
          </div>
        </div>
      </div>
    
  <%- include('includes/sidebar.ejs') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/c5614e6e6c.js" crossorigin="anonymous"></script>

  <script>
  document.querySelector('form').addEventListener('submit', function(event) {
    let brand = document.getElementById('brand').value;
    let quarter = document.getElementById('quarter').value;
    let year = document.getElementById('year').value;
    let disableYear = document.getElementById('disableYear').checked;

    if (!brand && !quarter && (!year || disableYear)) {
      event.preventDefault();
      window.location.href = "/reviews/";
    }
  });

     window.onload = function() {
        toggleYearInput(); // Verifica el estado de la casilla de verificación al cargar la página
    };

  function toggleYearInput() {
          const yearInput = document.getElementById('year');
          const disableCheckbox = document.getElementById('disableYear');
          yearInput.disabled = disableCheckbox.checked;
      }

    function submitForm() {
      document.getElementById("filterForm").submit();
    }
  </script>
</body>

</html>
