<!DOCTYPE html>
<html>
<head>
  <%- include('includes/head.ejs', {permisos: permisos}) %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://kit.fontawesome.com/c5614e6e6c.js" crossorigin="anonymous"></script>
</head>
<body>
    <%- include('includes/header.ejs') %>

<div class="col-md-9 m-auto">
    <div class="container mt-5">        
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 class="mb-4">
          <% if (itemCode && brand) { %>
            Analíticas de <%= itemCode %> de la marca: <b><%= brand %></b>
          <% } else if (itemCode) { %>
            Analíticas de <b><%= itemCode %></b>
          <% } else if (brand) { %>
            Analíticas de la marca: <b><%= brand %></b>
          <% } else { %>
            Analíticas
          <% } %>
        </h2>
        <a href="/analiticas">
          <button style="border: none; background-color: #F8F9FA;">
            <h2>
              <i class="fa-solid fa-right-from-bracket"></i>
            </h2>
          </button>
        </a>
      </div>
      
      <div class="container mt-5">
        <div class="row">
          <div class="col-md-4">
            <form id="combinedForm" method="POST" action="/analiticas/filteredAnalytics" class="border p-4 rounded">
              <h3>Buscar las Analíticas</h3>
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <div class="form-group">
                            <label for="brandInput">Marca:</label>
                            <select class="form-control" id="brandInput" name="brand" aria-placeholder="">
                              <option selected value=""> Elige una marca</option>
                              <% brands.forEach(brand => { %>
                                  <option value="<%= brand.NombreMarca %>"><%= brand.NombreMarca %></option>
                              <% }); %>
                          </select>
                        </div>
                        <div class="form-group">
                            <label class="mt-3" for="itemCode">Código:</label>
                            <input type="text" class="form-control" id="itemCode" name="itemCode" placeholder="LB0000" disabled>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" value="" id="itemCodeCheck">
                                <label class="form-check-label" for="itemCodeCheck">
                                    Activar búsqueda por código
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="mt-3" for="yearInput">Año:</label>
                            <input type="number" class="form-control" id="yearInput" name="year" placeholder="20##" min="2023" max="2099" step="1">
                        </div>
                        <div class="form-group mt-3">
                            <input type="checkbox" class="form-check-input" id="mostrarCuartiles" name="mostrarCuartiles">
                            <label for="mostrarCuartiles">Mostrar Graficos por Cuartiles</label>
                        </div>
                        <button type="submit" class="btn btn-secondary mt-3">Buscar</button>
            </form>
          </div>

          <!-- Columna para la gráfica -->
          <div class="col-md-8">
            <div class="row">
              <!-- Card 1 -->
              <div class="col-md-12">
                <div class="card">
                  <div class="card-body">
                    <% if (analytics.length === 0) { %>
                      <h5 class="card-title">No hay analíticas para esos parámetros</h5>
                    <% } else { %>
                      <select id="chartType1">
                        <option value="bar">Barras</option>
                        <option value="line">Linea</option>
                        <option value="scatter">Dispersión</option>
                      </select>
                      <canvas id="chart1"></canvas>
                    <% } %>
                    </div>
                  </div>
                </div>
                <%
                let promedios = [];
                analytics.forEach(item => {
                    promedios.push(item.PromedioCalificacionMensual);
                });
                
                let analyticsJSON = JSON.stringify(analytics); 
                %>
                
                <script>
                let analytics = JSON.parse('<%- analyticsJSON %>');
                let brandColors = {
                  'NOOZ': '#228491', // Nooz Color
                  'LUUNA': '#113565', //Luuna Color
                  'MAPPA': '#000000' //Mappa Color
                };
                let color = brandColors[analytics[0].NombreMarca] || '#99a1b0'; // default to black if brand is not found
                let promedios = [];
                let meses = [];
                let nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

                analytics.forEach(item => {
                  promedios.push(item.PromedioCalificacionMensual);
                  meses.push(nombresMeses[item.Mes - 1]);
                });

                // Valores de los gráficos de Luuna
                const data1 = {
                  labels: meses,
                  datasets: [{
                    label: 'Promedio de calificación',
                    data: promedios,
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 1,
                  }]
                };

                const config1 = {
                  type: 'bar', // Este valor será reemplazado por el valor del selector
                  data: data1,
                  options: {
                    scales: {
                      y: {
                        beginAtZero: true,
                        max: 5
                      }
                    }
                  }
                };

                // RENDERIZAR GRÁFICOS
                const chart1 = new Chart(
                  document.getElementById('chart1'),
                  config1
                );

                document.addEventListener('DOMContentLoaded', (event) => {
                  // Recuperar el estado de la casilla de verificación del almacenamiento local
                  let isChecked = localStorage.getItem('itemCodeCheck');
                  if (isChecked === 'true') {
                    document.getElementById('itemCodeCheck').checked = true;
                    document.getElementById('itemCode').disabled = false;
                    document.getElementById('brandInput').disabled = true;
                  }
                });
                
                document.getElementById('itemCodeCheck').addEventListener('change', function() {
                  document.getElementById('itemCode').disabled = !this.checked;
                  document.getElementById('brandInput').disabled = this.checked;
                
                  // Almacenar el estado de la casilla de verificación en el almacenamiento local
                  localStorage.setItem('itemCodeCheck', this.checked);
                });
                
                function submitForm(brand) {
                  document.getElementById('brandInput').value = brand;
                  document.getElementById('yearInput').value = document.getElementById('year').value; // Establecer el año
                  document.getElementById('brandForm').submit();
                }
                
              </script>
              </div>
      </div>
    </div>
</div>

</div>

<%- include('includes/sidebar.ejs') %>
</body>
</html>