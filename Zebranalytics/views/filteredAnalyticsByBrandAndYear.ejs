<!DOCTYPE html>
<html>
<head>
  <%- include('includes/head.ejs', {permisos: permisos}) %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
    <%- include('includes/header.ejs') %>

<div class="col-md-9 m-auto">
    <div class="container mt-5">        
        <h2 class="mb-4">Analíticas</h2>
        <a href="/analiticas"><button>Regresar</button></a>

        <div class="container mt-5">
            <div class="row">
              <div class="row">
                <!-- Card 1 -->
                <div class="col-md-12">
                  <div class="card">
                    <div class="card-body">
                      <% if (analytics.length === 0) { %>
                        <h5 class="card-title">No hay analíticas para esos parámetros</h5>
                      <% } else { %>
                        <h5 class="card-title">Promedios de las reseñas de <%= brand %> a lo largo de los meses</h5>
                        <select id="chartType1">
                          <option value="bar">Barras</option>
                          <option value="line">Linea</option>
                          <option value="scatter">Dispersión</option>
                        </select>
                        <canvas id="chart1"></canvas>
                      <% } %>
                    </div>
                  </div>
                </div>
                <%
                let promedios = [];
                analytics.forEach(item => {
                    promedios.push(item.PromedioCalificacionMensual);
                });
                
                let analyticsJSON = JSON.stringify(analytics); 
                %>
                
                <script>
                  
                let analytics = JSON.parse('<%- analyticsJSON %>');
                let brandColors = {
                  'NOOZ': '#228491', // Nooz Color
                  'LUUNA': '#113565', //Luuna Color
                  'MAPPA': '#000000' //Mappa Color
                };
                let color = brandColors[analytics[0].NombreMarca] || '#99a1b0'; // default to black if brand is not found
                let promedios = [];
                let meses = [];
                let nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

                analytics.forEach(item => {
                  promedios.push(item.PromedioCalificacionMensual);
                  meses.push(nombresMeses[item.Mes - 1]);
                });

                // Valores de los gráficos de Luuna
                const data1 = {
                  labels: meses,
                  datasets: [{
                    label: 'Promedio de calificación',
                    data: promedios,
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 1,
                  }]
                };

                const config1 = {
                  type: 'bar', // Este valor será reemplazado por el valor del selector
                  data: data1,
                  options: {
                    scales: {
                      y: {
                        beginAtZero: true,
                        max: 5
                      }
                    }
                  }
                };

                // RENDERIZAR GRÁFICOS
                const chart1 = new Chart(
                  document.getElementById('chart1'),
                  config1
                );

                // Manejar el cambio de tipo de gráfico
                document.getElementById('chartType1').addEventListener('change', function() {
                  chart1.config.type = this.value;
                  chart1.update();
                });
                
              </script>
              </div>
      </div>
    </div>
</div>

</div>

<%- include('includes/sidebar.ejs') %>
</body>
</html>